import { URL } from 'url';
import showdown from 'showdown';
import { Maybe } from 'true-myth';
import { Logger } from './logger';
import { Review } from './review';
import HypothesisAnnotationId from '../types/hypothesis-annotation-id';
import { Json, JsonCompatible } from '../types/json';

export type GetJson = (uri: string) => Promise<Json>;

export type FetchHypothesisAnnotation = (id: HypothesisAnnotationId) => Promise<Review>;

type HypothesisResponse = JsonCompatible<{
  created: string;
  text: string;
  links: {
    incontext: string;
  };
}>;

export default (getJson: GetJson, logger: Logger): FetchHypothesisAnnotation => {
  const converter = new showdown.Converter({ noHeaderId: true });
  converter.setFlavor('github');
  return async (id) => {
    if (id.value === 'g6HjYiA8EeueyaPMZHIn7g') {
      return {
        publicationDate: Maybe.just(new Date('2020-11-06')),
        fullText: Maybe.just(`
**Author Response**

> **Summary:** This study tackles a difficult problem of understanding the basis for hippocampal theta rhythms through reduction of a highly detailed model, seeking to validate a reduced model that would be more amenable to analysis. The reviewers appreciated the attention to this challenging problem and the substantial work that went into it, but had several fundamental concerns about the methodology, interpretation, and reporting.*

We appreciate the detailed feedback provided to us by the reviewers and editors and we are pleased that there was an appreciation for the attention we have given to this challenging problem and the substantial work that went into it.  We would like to thank the reviewers for their efforts.

This feedback helped us realize that there was possibly too much presented in this single paper and moving forward, we will split the work into two papers.  While we agree with some of the feedback, we think that some aspects were misunderstood, which may be partially due to the extensiveness of the submitted paper.  Below we provide general responses to the points raised, leaving specifics for elsewhere.

> **Reviewer #1:**
>
> *This study takes two existing models of hippocampal theta rhythm generation, a reduced one with two populations of Izhikevich neurons, and a detailed one with numerous biophysically detailed neuronal models. The authors do some parameter variation on 3 parameters in the reduced model and ask which are sensitive control parameters. They then examine control of theta frequency through a phase response curve and propose an inhibition-based tuning mechanism. They then map between the reduced and detailed model, and find that connectivity but not synaptic weights are consistent. They take a subset of the detailed model and do a 2 parameter exploration of rhythm generation. They compare phenomenological outcomes of the model with results from an optogenetic experiment to support their interpretation of an inhibition-based tuning mechanism for intrinsic generation of theta rhythm in the hippocampus.*

This statement summarizes our work to a certain extent but it misses a key aspect \u2013 the \u2018mapping\u2019 between the minimal (that this reviewer refers to as \u2018reduced\u2019) and detailed model is what is used to rationalize and motivate the subsequent extensive 2-parametric exploration in a \u2018piece\u2019 of the detailed model (which we termed the segment model). We will aim to write this more clearly in an edited version.

*General comments:*

*1) The paper shows the existence of potential rhythm mechanisms, but the approach is illustrative rather than definitive. For example, in a very lengthy section on parameter exploration in the reduced model, the authors find some domains which do and don't exhibit rhythms. Lacking further  exploration or analytic results, it is hard to see if their interpretations are conclusive.*

We agree that these are interpretations (not meant to be conclusive), but the goal was to use the minimal model to develop further insight as we did with a hypothesis development presented in the middle of the paper.

*2) The authors present too much detail on too few dimensions of parameters. An exhaustive parameter search would normally go systematically through all parameters, and be digested in an automated manner. For reporting this, a condensed summary would be presented. Here the authors look at 3 parameters for the reduced model and 2 parameters in the detailed one - far fewer than the available parameter set. They discuss the properties of these parameter choices at length, but then pick out a couple of illustrative points in the parameter domain for further pursuit. This leaves the reader rather overwhelmed on the one hand, and is not a convincing thorough exploration of all parameters of the system on the other.*

See above.

*3) I wonder if the 'minimal' model is minimal enough. Clearly it is well- supplied with free parameters. Is there a simpler mapping to rate models or even dynamical systems that might provide more complete insights, albeit at the risk of further abstraction?*

We agree that models can be even more minimal, but the goal here was not to further analyse the minimal model through simpler mappings or otherwise.  Rather, it was to exploit linkages between the minimal model and detailed models to help understand how theta rhythms could be generated in the biological system (Goutagny et al. 2009 intrinsic theta), using a piece of the detailed model as a \u2018biological proxy\u2019.\n\n*4) Around line 560 and Fig 12 the authors conclude that only case a) is consistent with experiment. While it is important to match data to experiment, here the match is phenomenological. It misses the opportunity to do a quantitative match which could be done by taking advantage of the biological detail in the model. *\n\n*5) The paper is far too long and is a difficult read. Many items of discussion are interspersed in the results, for example around line 335 among many others.*\n\nWe will split the paper into two.\n\n***Reviewer #2:***\n\n*In this work Chatzikalymniou et al. use models of hippocampus of different complexities to understand the emergence and robustness of intra-hippocampal theta rhythms. They use a segment of highly detailed model as a bridge to leverage insights from a minimal model of spiking point neurons to the level of a full hippocampus. This is an interesting approach as the minimal model is more amenable to analysis and probing the parameter space while the detailed model is potentially closer to experiment yet difficult and costly to explore.*\n\nWe completely agree.\n\n*The study of network problems is very demanding, there are no good ways to address robustness of the realistic models and the parameter space makes brute force approaches impractical. The angle of attack proposed here is interesting. While this is surely not the only approach tenable, it is sensible, justified, and actually implemented. The amount of work which entered this project is clear. I essentially accept the proposed reasoning and the hypotheses put forward. The few remarks I have are rather minor, but I think they merit a response.*\n\n*1) l. 528-530 "This is particularly noticeable in Figure 9D where theta rhythms are present and can be seen to be due to the PYR cell population firing in bursts of theta frequency. Even more, we notice that the pattern of the input current to the PYR cells isn't theta-paced or periodic (see Figure 10Bi)."*\n\n*This is a loose statement. When you look at the raw LFP theta is also not apparent (e.g. Figure 9.Ei or Fi). What happens once you look at the spectrum of the activity shown in 10.Bi? Do you see theta or not?*\n\nWe agree \u2013 to be done.\n\n*2) l. 562 "This implies that the different E-I balances in the segment model that allow LFP theta rhythms to emerge are not all consistent with the experimental data, and by extension, the biological system."*\n\n*This is speculative. We do not know how generic the results of Amilhon et al. are. They showed what you can find experimentally, not what you cannot find experimentally. I agree with the statement from l.581, though : "Thus, from the perspective of the experiments of Amilhon et al. (2015) theta rhythm generation via a case a type pathway seems more biologically realistic ..."*\n\nWe agree \u2013 to edit accordingly.\n\n*3) There are several problems with access to code and data provided in the manuscript.*\n\n*l. 986, 1113 - osf.io does not give access*\n*l. 1027 - bitbucket of bezaire does not allow access*\n*l. 1030 - simtracker link is down*\n*l. 1129, 1141 - the github link does not exist (private repo?)*\n\nOur apologies that all of these were not made public as intended.\n\n*4) l. 1017 - Afferent inputs from CA3 and EC are also included in the form of Poisson-distributed spiking units from artificial CA3 and EC cells.*\n\n*Not obvious if Poisson is adequate here - did you check on the statistics of inputs? Any references? Different input statistics may induce specific correlations which might affect the size of fluctuations of the input current. I do not think this would be a significant effect here unless the departure from Poisson is highly significant. Any comments might be useful.*\n\nWe were simply using the same input protocol setup done by Bezaire et al. 2016. \n\n*5) l. 909 - "Euler integration method is used to integrate the cell equations with a timestep of 0.1 msec."*\n\n*This seems dangerous. Is the computation so costly that more advanced integration is not viable?*\n\nOur apologies as the timestep was erroneously reported.  At initial stages of the project, larger stepsizes were attempted to speed up computation.  The stepsize/integration used were as in minimal model of Ferguson et al. (2017).  That is, Euler integration with a 0.04ms stepsize for the cell simulations and Runge-Kutta for network simulations. \n\n***Reviewer #3:***\n\n*[...] I have a number of methodological issues with the paper. First, both models should be validated against experimental evidence given that the experimental results exist. The validation of a "minimal" model with data from another model is circumstantial and useful to link two models, but in no way is a scientific validation, in my opinion. Second, the model reduction arguments are simply taken as a piece of a large model. This is in now way a systematic reduction, which the authors should provide. In the absence of that, the two models are simply two different models. Third, it is not clear what aspects of the mechanisms cannot be investigated using the larger models that require the reduced models, given that the models do not necessarily match. Fourth, the concept of a minimal model should be clearly explained. They used caricature (toy) models of (2D quadratic models, aka Izhikevich models) combined with biophysically plausible descriptions of synapses. The model parameters in 2D quadratic models are not biophysical as the authors acknowledge, but they can be related to biophysical parameters through the specific equations provided in Rotstein (JCNS, 2015) and Turquist & Rotstein (Encyclopedia of Computational Neuroscience, 2018). In fact, they can represent either h-currents or M-currents. I suggest the authors determine this from these references. In this framework, the dynamics would result from a combination of these currents and persistent sodium or fast (transient) sodium activation. Fifth, from the original paper (Ferguson et al., 2017) their minimal model has 500 PV and 10000 PYR cells (I couldn't find the number of PV cells in this paper, but I assumed they were as in the original paper). This is not what I would call a minimal model. It is minimal only in comparison with the more detailed model. While this is a matter of semantics, it should be clarified since there are other minimal model approaches in the literature (e.g., Kopell group, Erdi group). Related to these models, it is typically assumed that the relationship between PYR to PV is 5/1. This is certainly not holy, but seems to have been validated. Here it is 20/1. Is there any reason for that? Sixth, the networks are so big that it is very difficult to gain some profound insight. What is it about the large networks and their contribution to the generation of theta activity that cannot be learned from "more minimal" networks?*\n\nThe published minimal model (Ferguson et al. 2017) used experimental data constraints on EPSC and IPSC ratios to come up with the prediction of connectivity. As this connectivity was found in the detailed model (with empirically determined connections), this can be considered a form of validation for the minimal model\u2019s predictions if one considers the detailed as a \u2018biological proxy\u2019.\n\nWe agree that the segment model is not a systematic reduction of the detailed model.  The segment model reasonably represents a \u2018piece\u2019 of the CA1 microcircuit that was experimentally shown to be possible to be able to generate oscillations on its own (see Goutagny et al. 2009 Supplementary figure 11).  This was the assumption in determining the network size of the previously published minimal model.  A large network is needed in order to appropriate capture the very large EPSCs relative to IPSCs that are present in the experiment.  This is the essence of why smaller network sizes cannot be justified. \n\n*Because of these concerns and the development of the paper, I believe the paper is about the comparison between two existing models that the authors have constructed in the past and the parameter exploration of these models.*\n\nWe do not fully agree with this statement.  The minimal model was constructed by us (Ferguson et al. 2017), but the detailed model was painstakingly constructed in a state-of-the-art fashion by Bezaire et al. 2016.  We used a \u2018piece\u2019 of this detailed model (see above) so that we could make \u2018links\u2019 with the minimal model in understanding the generation of intrinsic theta rhythms.  This \u2018piece\u2019 also allowed us to do the extensive exploration for the additional results presented.  The paper is about taking advantage of the comparison and linkage of minimal and detailed models to show how theta rhythms are generated and their frequencies controlled.\n\n*I find the paper extremely difficult to read. It is not about the narrative, but about the organization of the results and the lack (or scarcity) of clear statements. I can't seem to be able to easily extract the principles that emerge from the analysis. There are a big number of cases and data, but what do we get out of that?. Perhaps creating "telling titles" for each section/subsection would help, where the main result is the title of the section/subsection. I also find an issue with the acronyms. One has to keep track of numbers, cases, acronyms (N, B), etc. All that gets in the way of the understanding. I believe figures would help.*\n\n*Another confusing issue in the paper is the use of the concept of "building blocks". I am not opposed to the use of these words, on the contrary. But building blocks are typically associated with the model structure (e.g., currents in a neuron, neurons in a network). PIR, SFA and Rheo are a different type of building blocks, which I would call "functional building blocks". They are building blocks in a functional world of model behavior, but not in the world of modeling components. For example, PIR can be instantiated by different combinations of ionic currents receiving inhibitory inputs. Also, the definitions of the building blocks and how they are quantified should be clearly stated in a separate section or subsection.*\n\n*The concept of building blocks was directly taken from Gjorgjieva et al. 2016 as cited in Ferguson et al. 2017 when we first used it, but also cited in the present paper, but for a different point.*\n\n*I disagree with the authors' statement in lines 214-216, related to Fig. 4. They claim that "From them, we can say that the PYR cell firing does not speci1cally occur because of their IPSCs, as spiking can occur before or just after its IPSCs." Figure 4 (top, left panel) suggests the opposite, but instead of being a PIR mechanism, it is a "building-up" of the "adaptation" current in the PYR cell. (By "adaptation" current I mean the current corresponding to the second variable in the model. If this variable were the gating variable of the h-current, it would be the same type of mechanism suggested in Rotstein et al. (2005) and in the models presented in Stark et al. (2013).) The mechanism operates as follow: the first PV-spike (not shown in the figure) causes a rebound, which is not strong enough to produce a PYR spike before a new PV spike occurs (the first in the figure), this second PV-spike causes a stronger rebound (it is super clear in the figure), which is still not strong enough to produce a PYR-spike before the new PV-spike arrives, this third PV spike produces a still stronger rebound, which now causes a PYR spike. The fact that this PYR spike occurs before the PV spike is not indicative of the authors' conclusions, but quite the opposite.*\n\n*The authors should check whether the mechanistic hypothesis I just described, which is consistent with Fig. 4 (top, left panel), is also consist with the rest of the panels and, more generally, with their modeling results and the experimental data and whether it is general and, if not, what are the conditions under which it is. If my hypothesis ends up not being proven, then they should come up with an alternative hypothesis. The condition the authors' state about the parameter "b" and PIR is not necessarily general. PIR and other phenomena are typically controlled by the combined effect of more than one parameter. As it stands, their basic assumption behind the PRC is not necessarily valid.*\n\n*The subsequent hypothesis (about PYR bursting) is called to question in view of the previous comments. The experimental data should be able to provide an answer.*\n\nSee above.\n\n*The authors should provide a more detailed explanation and justification for the presence of an inhibitory "bolus". What would the timescale be? Again, the data should provide evidence of that. In their discussion about the PRC, the authors essentially conclude what they hypothesis, but this conclusion is based on the "bolus" idea. The validity of this should be revised.*\n\n*The discussion about degeneracy of the theta rhythm generation is interesting. However, because of the size and complexity of the models, this degeneracy is expected. Their minimal modeling approach does not help in shedding any additional light. In addition, the authors' do not discuss the intrinsic sources of degeneracy and how they interact with the intrinsic ones.*\n\n*The last two sections were difficult to follow and I found them anecdotal. I was expecting a deeper mechanistic analysis. However, I have to acknowledge that because of my difficulty in following the paper, I might have missed important issues.*\n\n*These last sections are where the \u2018piece\u2019 of the detailed model (that we termed the segment model) - a \u2018biological proxy\u2019 - essentially shows that the theta rhythm is initiated from the pyramidal cells and that the frequency is controlled by the net input to the pyramidal cells.*\n\n*The discussion is extensive, exhaustive and interesting. But it is not clear how the paper results are integrated in this big picture, except for a number of generic statements.*\n\n*The proposal that the hippocampus has the circuitry to produce theta oscillations without the need of medial septum input has been proposed before by Gillies et. (2003) and the models in Rotstein et al. (2005) and Orban et al. (2005). But the idea from this work is not that the hippocampus (CA1) is a pacemaker, but rather what we now call a "resonator". To claim that the MS is simply an amplificatory of an existing oscillator is against the existing evidence.*\n\nWe agree that many models show theta generation without explicit mention of the medial septum.  However, what our modelling work shows is how the intrinsic theta rhythm is generated \u2013 it is initiated by the pyramidal cells (large enough network size with some recurrent connections) and the control of the theta frequency (LFP) is due to the net input to the pyramidal cells \u2013 this is the main claim of the paper.  This is explicitly in reference to an intrinsic theta rhythm experimental context.  From there, we suggest that MS and other inputs could amplify an already existing intrinsic rhythm in the CA1 microcircuit.\n\n**References:**\n\nBezaire, M. J., Raikov, I., Burk, K., Vyas, D., & Soltesz, I. (2016). Interneuronal mechanisms of hippocampal theta oscillation in a full-scale model of the rodent CA1 circuit. ELife, 5, e18566. https://doi.org/10.7554/eLife.18566\n\nFerguson, K. A., Chatzikalymniou, A. P., & Skinner, F. K. (2017). Combining Theory, Model, and Experiment to Explain How Intrinsic Theta Rhythms Are Generated in an In Vitro Whole Hippocampus Preparation without Oscillatory Inputs. ENeuro, 4(4). https://doi.org/10.1523/ENEURO.0131-17.2017\n\nGjorgjieva, J., Drion, G., & Marder, E. (2016). Computational implications of biophysical diversity and multiple timescales in neurons and synapses for circuit performance. Current Opinion in Neurobiology, 37, 44\u201352. https://doi.org/10.1016/j.conb.2015.12.008\n\nGoutagny, R., Jackson, J., & Williams, S. (2009). Self-generated theta oscillations in the hippocampus. Nature Neuroscience, 12(12), 1491\u20131493. https://doi.org/10.1038/nn.2440
          `).map((text) => converter.makeHtml(text)),
        url: new URL('https://hyp.is/g6HjYiA8EeueyaPMZHIn7g/www.biorxiv.org/content/10.1101/2020.07.28.225557v1'),
      };
    }
    const uri = `https://api.hypothes.is/api/annotations/${id.value}`;

    logger('debug', 'Fetching review from Hypothesis', { uri });
    const data = await getJson(uri) as HypothesisResponse;

    const response: Review = {
      publicationDate: Maybe.just(new Date(data.created)),
      fullText: Maybe.just(data.text).map((text) => converter.makeHtml(text)),
      url: new URL(data.links.incontext),
    };

    logger('debug', 'Retrieved review', { ...response, fullText: '[text]' });

    return response;
  };
};
